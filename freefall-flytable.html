<!DOCTYPE html>
<html>
<head>
<title>Flyweight Table</title>
<script src="jquery-1.11.0.min.js"></script>
<script src="flytable.js"></script>

<script>

//http://freefall.purrsia.com/ff100/fv00001.gif
//http://freefall.purrsia.com/ff400/fv00376.gif
//http://freefall.purrsia.com/ff1300/fc01253.png

$(function() {

	var table = setupFlyTable($("#contain"));
	window.DebugTable = table;
	var tmpl = $(".tmpl .comic");

	function fixedLen(num,len){
		return("0000000000000000"+num).slice(-len);
	};
	
	// comic dimension data
	var data = [
		{i: 1, h: 242},
		{i: 1699, h: 310},
		{i: 1779, h: 629},
		{i: 1780, h: 310},
		{i: 2545, h: 334},
		{i: 2546, h: 310},
	];
	var numComics = 2650;
	
	// cook data
	var padding = 10;
	
	var h = data[0].h;
	var prev = {i: 0, h: 0, y: 0, last: 1};
	for(var i = 0; i < data.length; i++) {
		var item = data[i];
		
		if(item.h) {
			h = item.h + padding;
		}
		item.h = h;
		
		var span = item.i - prev.i;
		item.y = prev.y + span * prev.h;
		
		prev.last = item.i;
		prev.lastY = item.y;
		prev = item;
	}
	var lastEntry = data[data.length - 1];
	lastEntry.last = numComics;

	var lastSpan = numComics - lastEntry.i;
	var totalHeight = lastEntry.y + lastEntry.h * lastSpan;
	lastEntry.lastY = totalHeight;
	
	// URL logic
	var firstColor = 1253;
	function getUrl(num) {
		var bin = ((~~((num - 1) / 100)) * 100) + 100;
		//bin = fixedLen(bin, 3);
		num = fixedLen(num, 5);
		
		if(num == 1401) {
			// special case
			return "http://freefall.purrsia.com/ff1500/fc01401.jpg";
		} else if(num >= firstColor) {
			return "http://freefall.purrsia.com/ff"+bin+"/fc"+num+".png";
		} else {
			return "http://freefall.purrsia.com/ff"+bin+"/fv"+num+".gif";
		}
	};
	
	
	// flytable config
	table.scrollPadding = 300;

	table.getTotalHeight = function() {
		return totalHeight;
	};
	
	function getData(index) {
		for(var i = 0; i < data.length; i++) {
			var item = data[i];
			
			if(index >= item.i && index < item.last) {
				return item;
			}
		}
		return false; // failure, crash
	};
	table.getItemTop = function(index) {
		var entry = getData(index);
		
		var offset = index - entry.i;
		var y = entry.y + entry.h * offset;

		return y;
	};
	table.getItemHeight = function(index) {
		var entry = getData(index);
		return entry.h;
	};

	table.pixelToIndex = function(y) {
		for(var i = 0; i < data.length; i++) {
			var item = data[i];
			
			if(y >= item.y && y < item.lastY) {
				var offset = y - item.y;
				
				var indexOffset = ~~(offset / item.h);
				
				return item.i + indexOffset;
			}
		}
		
		if(y <= 0) {
			return 0;
		} else {
			return numComics;
		}
	}
	var ii = 0;
	table.getComponent = function(index, node) {
		if(!node) {
			node = tmpl.clone();
			//node.find(".dbg").text(""+(ii++));
			node.find("img").on("load", function(evt) {
				console.log("img", evt);
			});
		}
		// 1-index comics
		index = index + 1;
		var url = getUrl(index);
		//node.find(".dbg").text(url);
		node.find(".num").text(index);
		node.find("img").attr("src", url).show();
		
		return node;
	};
	table.recycleComponent = function(node) {
		node.find("img").attr("src", null);
	};

	// event hookup
	$(document).on("scroll", function() {
		table.render();
	});
	
	table.render();

})

</script>

<style>
.tmpl {
	display: none;
}
.comic {
	width: 1100px;
}
.comic .bg {
	position: absolute;
	display: block;
	/*background: #eee;*/
	border-radius: 32px;
	top: 0; left: 0; right: 0; bottom: 0;
}
.comic .num {
	position: absolute;
	top: 0; right: 32px;
	color: black;
	font-weight: bold;
	background: white;
	padding: 3px;
	z-index: 1;
}
.comic img {
	position: absolute;
	top: 0; left: 32px;
	z-index: 0;
}
</style>
</head>
<body>

<div id="contain"></div>

<hr />

<div class="tmpl">
<div class="comic">
<div class="bg">
<span class="dbg"></span>
<span class="num"></span>
<img />
</div>
</div>
</div>

</body>
</html>

