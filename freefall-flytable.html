<!DOCTYPE html>
<html>
<head>
<title>Freefall Archive Binge Speedreader</title>
<script src="jquery-1.11.0.min.js"></script>
<script src="flytable.js"></script>

<script>

/* Speedreader and flytable.js coded by tangent128 */
/* https://github.com/Tangent128 */

$(function() {

	var container = $("#contain");
	var table = setupFlyTable(container);
	window.DebugTable = table;
	var tmpl = $(".tmpl .comic");

	function fixedLen(num,len){
		return("0000000000000000"+num).slice(-len);
	};
	
	/* comic dimension data */
	var data = [
		{i: 1, h: 242, ext: ".gif"},
		{i: 700, h: 492},
		{i: 701, h: 242},
		{i: 710, h: 492},
		{i: 711, h: 242},
		{i: 1072, h: 492},
		{i: 1073, h: 242},
		{i: 1253, ext: ".png"},
		{i: 1401, ext: ".jpg"},
		{i: 1402, ext: ".png"},
		{i: 1492, h: 489},
		{i: 1493, h: 242},
		{i: 1496, h: 489},
		{i: 1497, h: 242},
		{i: 1700, h: 310},
		{i: 1780, h: 629},
		{i: 1781, h: 310},
		{i: 2546, h: 334},
		{i: 2547, h: 310},
	];
	var numComics = 2634;
	
	// cook data
	var padding = 20;
	
	var h = data[0].h;
	var ext = data[0].ext;
	var prev = {i: 0, h: 0, y: 0};
	for(var i = 0; i < data.length; i++) {
		var item = data[i];
		
		if(item.h) {h = item.h + padding;}
		item.h = h;
		
		if(item.ext) {ext = item.ext;}
		item.ext = ext;
		
		var span = item.i - prev.i;
		item.y = prev.y + span * prev.h;
		
		prev.last = item.i;
		prev.lastY = item.y;
		prev = item;
	}
	var lastEntry = data[data.length - 1];
	lastEntry.last = numComics + 1;

	var lastSpan = lastEntry.last - lastEntry.i;
	var totalHeight = lastEntry.y + lastEntry.h * lastSpan;
	lastEntry.lastY = totalHeight;
	
	// URL logic
	var firstColor = 1253;
	function getUrl(num, ext) {
		var bin = ((~~((num - 1) / 100)) * 100) + 100;
		var padNum = fixedLen(num, 5);
		
		if(num >= firstColor) {
			return "http://freefall.purrsia.com/ff"+bin+"/fc"+padNum+ext;
		} else {
			return "http://freefall.purrsia.com/ff"+bin+"/fv"+padNum+ext;
		}
	};
	
	
	/* flytable config */
	table.scrollPadding = 300;

	table.getTotalHeight = function() {
		return totalHeight;
	};
	
	function getData(index) {
		for(var i = 0; i < data.length; i++) {
			var item = data[i];
			
			if(index >= item.i && index < item.last) {
				return item;
			}
		}
		return false; // failure, just crash
	};
	table.getItemTop = function(index) {
		var entry = getData(index);
		
		var offset = index - entry.i;
		var y = entry.y + entry.h * offset;

		return y;
	};
	table.getItemHeight = function(index) {
		var entry = getData(index);
		return entry.h;
	};

	table.pixelToIndex = function(y) {
		for(var i = 0; i < data.length; i++) {
			var item = data[i];
			
			if(y >= item.y && y < item.lastY) {
				var offset = y - item.y;
				
				var indexOffset = ~~(offset / item.h);
				
				return item.i + indexOffset;
			}
		}
		
		if(y <= 0) {
			return 0;
		} else {
			return numComics;
		}
	}
	var ii = 0;
	table.getComponent = function(comicNum, node) {
		if(!node) {
			node = tmpl.clone();
			//node.find(".dbg").text(""+(ii++));
			node.find("img").on("load", function(evt) {
				console.log("img", evt);
			});
		}
		var entry = getData(comicNum);
		var imgUrl = getUrl(comicNum, entry.ext);
		var pageUrl = getUrl(comicNum, ".htm");
		//node.find(".dbg").text(url);
		node.find(".num").text(comicNum).attr("href", pageUrl);
		node.find("img").attr("src", imgUrl).show();
		
		return node;
	};
	table.recycleComponent = function(node) {
		node.find("img").attr("src", null);
	};

	/* support for linking to individual comics */

	function jumpToHash() {
		if(location.hash) {
			var comicNum = 1 * location.hash.replace("#", "");
			var baseY = container.offset().top;
			var comicY = table.getItemTop(comicNum);
			
			window.scrollTo(0, baseY + comicY);
			console.log("scrollTo", baseY + comicY);
			
			// just in case the window.scrollTo()
			// call didn't fire a scroll event
			table.render();
		}
	}

	/* event hookup */
	$(document).on("scroll", function() {
		table.render();
	});
	$(window).on("hashchange", function() {
		jumpToHash()
		table.render();
	});
	
	// pre-render ensures the page has correct vertical space usage
	table.render();
	jumpToHash();
	
	$("#moreLink").attr("href", getUrl(numComics, ".htm"));

})

</script>

<style>
body {
	color: #000;
	background: #ffcc99 url(http://freefall.purrsia.com/bkgd.gif);
}
.tmpl {
	display: none;
}
.comic {
	width: 1100px;
}
.comic .bg {
	position: absolute;
	display: block;
	/*background: #eee;*/
	border-radius: 32px;
	top: 0; left: 0; right: 0; bottom: 0;
}
.comic .num {
	position: absolute;
	top: 0; right: 32px;
	font-weight: bold;
	padding: 3px;
	z-index: 1;
}
.comic img {
	position: absolute;
	top: 0; left: 32px;
	z-index: 0;
}
.block {
	margin-left: 32px;
	padding: 16px;

	background: #ffc;
}
.headBlock {
	border: 2px solid black;
	width: calc(768px - (16px + 2px) * 2);
	margin-bottom: 20px;
	font-size: 16px;
	
}
.headBlock h1 {
	margin: 0;
}
.small {
	font-size: 12px;
}
.moreBlock {
	border: 3px solid black;
	width: calc(982px - (16px + 3px) * 2);

	background: #0dc8b0;
	/*border-radius: 16px;*/
	
	font-size: 24px;
}
</style>
</head>
<body>

<div class="block headBlock">
<h1>Freefall Archive Binge Speedreader</h1>
<p>This tool allows reading Freefall in a continuous format, uninterrupted
by page loads. It will automatically load comics as they scroll onscreen,
so your browser doesn't have to download everything at once.</p>

</div>

<div id="contain"></div>

<div class="comic">
<div class="block moreBlock">
Continue reading at <a id="moreLink">the proper archives</a>
</div>
</div>

<hr />

<p class="small">Freefall is written and drawn by Mark Stanley. This interface was coded by Tangent.</p>

<div class="tmpl">
<div class="comic">
<div class="bg">
<span class="dbg"></span>
<a class="num"></a>
<img />
</div>
</div>
</div>

</body>
</html>

