<!DOCTYPE html>
<html>
<head>
<title>Flyweight Table</title>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

<script>

function setupFlyTable(element) {
	
	var table = {};
	table.container = element;
	table.recycle = [];
	table.inUse = [];
	table.sliceStart = 0;
	table.sliceEnd = 0;

	// extra space on either side to render
	var SCROLL_BUFFER = 10;
	
	/* Public Overrides */
	
	table.recalculate = function() {}
	
	table.getComponent = function(index, recycle) {
		if(!recycle) {
			recycle = $("<s>no renderer</s>");
		}
		
		return recycle;
	}
	
	table.getItemTop = function(index) {
		return 16*index; // arbitrary value
	}
	
	table.getItemHeight = function(index) {
		return 16; // arbitrary value
	}
	
	table.getTotalHeight = function() {
		return 160; // arbitrary value
	}

	table.pixelToIndex = function(y) {
		return ~~(y / this.getItemHeight(0));
	}

	/* Internal Functions */
	
	function recycleOffscreenNodes() {
	}
	function recycleAllNodes() {
		var inUse = table.inUse;
		var recycle = table.recycle;
		
		for(var i = 0; i < inUse.length; i++) {
			recycle.push(inUse[i]);
		}
		
		table.inUse = [];
	}

	function grabNode() {
		if(table.recycle.length > 0) {
			return table.recycle.pop();
		}
		return false;
	}
	
	// util, limit an event handler to only run every 20ms
	function burnout(func) {
		var burnedOut = false;
		return function(evt) {
			if(burnedOut) {
				return;
			}
			burnedOut = true;
			window.setTimeout(function() {burnedOut = false;}, 20);
			return func.apply(this, evt);
		}
	}
	
	function renderSlice(startY, endY) {
		var t = table.container;
		t.empty();
		
		table.recalculate();
		recycleAllNodes();
		
		// pad region
		var height = table.getTotalHeight();
		startY = Math.max(0, startY - SCROLL_BUFFER);
		endY = Math.min(endY + SCROLL_BUFFER, height)
		
		var index = table.pixelToIndex(startY);
		
		for(var y = table.getItemTop(index); y < endY;) {
			var h = table.getItemHeight(index);
			var domNode = table.getComponent(index, grabNode());
			domNode.css({
				position: "absolute",
				left: "0",
				right: "0",
				top: y
			});
			t.append(domNode);
			index++;
			y += h;
		}
		
		table.container.css({
			position: "relative",
			height: height
		});
	}
	
	/* Public Methods */
	
	table.render = function() {
		var screenY = $(window).scrollTop();
		var tableY = this.container.offset().top;
		var delta = screenY - tableY;
		renderSlice(delta, delta + $(window).height());
	}
	
	// utility for displaying fixed datasets of uniform row height
	table.simpleArray = function(data, templateSelector, renderFunc) {
		var tmpl;
		var rowHeight;
		
		this.recalculate = function() {
			tmpl = $(templateSelector);
			rowHeight =tmpl.height();
		}
		
		this.getComponent = function(index, node) {
			if(!node) {
				node = tmpl.clone();
			}
		
			var dataItem = data[index];
			renderFunc(dataItem, node, index);
			
			return node;
		}
		
		this.getItemTop = function(index) {
			return rowHeight*index;
		}
		
		this.getItemHeight = function(index) {
			return rowHeight;
		}

		this.getTotalHeight = function() {
			return rowHeight * data.length;
		}
	}
	
	/* End */
	
	return table;
}
</script>

<script>

var data = [];
var strs = ["alphabet", "beatitudes", "casablanca", "danish sockets", "eccentric ecindnas", "flapjacks", "gardener"];

for(var i = 0; i < 3000; i++) {
	var item = {};
	item.a = i;
	var chaos = ((i*23) >> 3) ^ i;
	item.b = chaos;
	item.c = strs[chaos % strs.length];
	data.push(item);
}

$(function() {
	var table = setupFlyTable($("#contain"));
	
	table.simpleArray(data, ".tmpl .item", function(data, node) {
		node.find(".a").text(data.a);
		node.find(".b").text(data.b);
		node.find(".c").text(data.c);
	});
	
	//setInterval(function() {table.render()}, 500)

	$(document).on("scroll", function() {
		table.render();
	});
	
	table.render();

	$("#scroller").add(document).on("scroll", function() {
		$("#contain .item").each(function() {
			var item = $(this);
			var o = item.offset();
			item.find(".c").text(o.left + ", " + o.top);
		});
	});

})

</script>

<style>
#scroller {
	height: 250px;
	overflow-y: scroll;
}
.item {
	display: block;
	background: #888;
	border-radius: 5px;
	height: 30px;
}
</style>
</head>
<body>

<div id="contain" style="border: thick red solid"></div>
<div id="scroller"></div>

<hr />

<div class="tmpl">
<div class="item">
<b class="a"></b> <span class="b"></span> <i class="c"></i>
</div>
</div>

</body>
</html>

